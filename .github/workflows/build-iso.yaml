name: VyOS nightly build

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      BUILD_BY:
        description: "Build by identifier"
        required: false
        default: "hauke-cloud"
      build_version:
        description: "Build version (leave empty for auto-generated)"
        required: false

env:
  BUILD_BY: hauke-cloud
  DEBIAN_MIRROR: http://deb.debian.org/debian/
  DEBIAN_SECURITY_MIRROR: http://deb.debian.org/debian-security
  VYOS_MIRROR: https://packages.vyos.net/repositories/current/

jobs:
  build_generic_iso:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      BUILD_BY: ${{ steps.set_env_variables.outputs.BUILD_BY }}
      build_version: ${{ steps.set_env_variables.outputs.build_version }}
      TIMESTAMP: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
      generic_image_iso: ${{ steps.build_generic_iso.outputs.generic_image_iso }}
      generic_image_name: ${{ steps.build_generic_iso.outputs.generic_image_name }}

    steps:
      ### Initialization ###
      - uses: actions/checkout@v4

      - name: "Initialization: set env variables"
        id: set_env_variables
        run: |
          set -x
          if [ -n "${{ github.event.inputs.BUILD_BY }}" ]; then
            echo "BUILD_BY=${{ github.event.inputs.BUILD_BY }}" >> $GITHUB_ENV
          fi
          if [ -z "${{ github.event.inputs.build_version }}" ]; then
            echo "build_version=1.5-rolling-$(date -u +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          else
            echo "build_version=${{ github.event.inputs.build_version }}" >> $GITHUB_OUTPUT
          fi
          echo "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "BUILD_BY=$BUILD_BY" >> $GITHUB_OUTPUT

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            python3 \
            python3-pip \
            python3-venv \
            squashfs-tools \
            genisoimage \
            fakechroot \
            jq

      - name: Checkout vyos-build repo
        uses: actions/checkout@v4
        with:
          repository: vyos/vyos-build
          path: vyos-build

      - name: Download vyos-customization package from releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Downloading vyos-customization Package"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Get the latest release info from GitHub API with authentication
          echo "ðŸ“¦ Fetching latest vyos-customization release info..."
          RELEASE_INFO=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/hauke-cloud/vyos-customization/releases/latest)
          
          # Check if we got a valid response
          if echo "$RELEASE_INFO" | jq -e '.tag_name' > /dev/null 2>&1; then
            CUSTOMIZATION_VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
            DEB_FILE=$(echo "$RELEASE_INFO" | jq -r '.assets[0].name')
            DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[0].browser_download_url')
          else
            echo "âš ï¸  Could not fetch from API, using fallback version"
            echo "API Response: $RELEASE_INFO"
            CUSTOMIZATION_VERSION="v0.0.1"
            DEB_FILE="vyos-customization_1.0.0-1_all.deb"
            DOWNLOAD_URL="https://github.com/hauke-cloud/vyos-customization/releases/download/v0.0.1/vyos-customization_1.0.0-1_all.deb"
          fi
          
          echo "  Version: $CUSTOMIZATION_VERSION"
          echo "  File: $DEB_FILE"
          echo "  URL: $DOWNLOAD_URL"
          echo ""
          
          # Create packages directory
          mkdir -p vyos-build/packages
          
          # Download the .deb package
          echo "ðŸ“¥ Downloading package..."
          if ! curl -L -f -o "vyos-build/packages/$DEB_FILE" "$DOWNLOAD_URL"; then
            echo "âŒ Download failed!"
            exit 1
          fi
          
          echo ""
          echo "âœ“ Package downloaded:"
          ls -lh vyos-build/packages/
          echo ""
          
          # Export version for use in later steps
          echo "CUSTOMIZATION_VERSION=$CUSTOMIZATION_VERSION" >> $GITHUB_ENV
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… Package Ready (version $CUSTOMIZATION_VERSION)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: Build generic ISO image using Docker
        id: build_generic_iso
        run: |
          cd vyos-build
          # Use Docker to build the ISO with privileged mode
          docker pull vyos/vyos-build:current

          # Run the build in Docker with privileged mode (required for mounting)
          docker run --rm \
            --privileged \
            -v "$(pwd)":/vyos \
            -w /vyos \
            -e BUILD_BY="$BUILD_BY" \
            -e DEBIAN_MIRROR="$DEBIAN_MIRROR" \
            -e DEBIAN_SECURITY_MIRROR="$DEBIAN_SECURITY_MIRROR" \
            -e VYOS_MIRROR="$VYOS_MIRROR" \
            --sysctl net.ipv6.conf.lo.disable_ipv6=0 \
            vyos/vyos-build:current \
            sudo ./build-vyos-image \
              --architecture amd64 \
              --build-by "$BUILD_BY" \
              --build-type release \
              --custom-package vyos-1x-smoketest \
              --debian-mirror "$DEBIAN_MIRROR" \
              --debian-security-mirror "$DEBIAN_SECURITY_MIRROR" \
              --version "${{ steps.set_env_variables.outputs.build_version }}" \
              --vyos-mirror "$VYOS_MIRROR" \
              generic

          cd build
          # Determine image name and iso file
          if [ -f manifest.json ]; then
            GENERIC_IMAGE_ISO=$(jq --raw-output '.artifacts[0]' manifest.json)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          else
            # Fallback: find the ISO file directly
            GENERIC_IMAGE_ISO=$(ls -1 *.iso | head -n1)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          fi
          
          # Rename ISO to include customization version
          NEW_ISO_NAME="${GENERIC_IMAGE_NAME}-custom-${CUSTOMIZATION_VERSION}.iso"
          mv "${GENERIC_IMAGE_ISO}" "${NEW_ISO_NAME}"
          GENERIC_IMAGE_ISO="${NEW_ISO_NAME}"
          GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)

          echo "generic_image_name=${GENERIC_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "generic_image_iso=${GENERIC_IMAGE_ISO}" >> $GITHUB_OUTPUT

          # Fix ownership and move artifacts to workspace
          sudo chown -R $(id -u):$(id -g) .
          [ -f manifest.json ] && mv manifest.json $GITHUB_WORKSPACE/ || echo '{"artifacts": []}' > $GITHUB_WORKSPACE/manifest.json
          mv ${GENERIC_IMAGE_ISO} $GITHUB_WORKSPACE/

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          cp ${{ steps.build_generic_iso.outputs.generic_image_iso }} release-artifacts/
          cp manifest.json release-artifacts/
          
          # Create README for the release
          cat > release-artifacts/README.md << 'EOF'
          # VyOS Custom ISO Release
          
          ## Files Included
          
          - **ISO File**: `${{ steps.build_generic_iso.outputs.generic_image_iso }}` - The custom VyOS ISO image
          - **manifest.json**: Build manifest with metadata
          
          ## Usage
          
          ### Download the ISO
          
          Download the ISO file from this release and use it to install VyOS.
          
          ## Build Information
          
          - **Version**: ${{ steps.set_env_variables.outputs.build_version }}
          - **Built by**: ${{ steps.set_env_variables.outputs.BUILD_BY }}
          - **Build time**: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
          - **Architecture**: amd64
          - **Type**: rolling release
          
          ## Customizations
          
          This ISO includes vyos-customization package version ${{ env.CUSTOMIZATION_VERSION }}:
          - Custom default configuration
          - Post-installation scripts
          - Auto-install functionality
          - Password generation utilities
          
          See the [vyos-customization repository](https://github.com/hauke-cloud/vyos-customization) for full details.
          EOF
          
          # Create checksums
          cd release-artifacts
          sha256sum ${{ steps.build_generic_iso.outputs.generic_image_iso }} > SHA256SUMS
          sha256sum manifest.json >> SHA256SUMS
          cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_generic_iso.outputs.generic_image_name }}
          path: |
            manifest.json
            ${{ steps.build_generic_iso.outputs.generic_image_iso }}
          retention-days: 15
          if-no-files-found: error

      - name: Create Release
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.set_env_variables.outputs.build_version }}
          name: VyOS ${{ steps.set_env_variables.outputs.build_version }}
          body: |
            # VyOS Custom ISO Build
            
            Automated build of VyOS with custom configurations.
            
            ## ðŸ“¦ Downloads
            
            - **ISO Image**: Download the `.iso` file below
            - **SHA256SUMS**: Verify download integrity
            
            ## ðŸš€ Quick Start
            
            1. Download the ISO file
            2. Use with your preferred virtualization platform or cloud provider
            
            ## ðŸ“‹ Build Details
            
            - **Version**: ${{ steps.set_env_variables.outputs.build_version }}
            - **Built by**: ${{ steps.set_env_variables.outputs.BUILD_BY }}
            - **Build time**: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
            - **Architecture**: amd64 (generic)
            - **Commit**: ${{ github.sha }}
            
            ## ðŸ”§ Included Customizations
            
            This build includes vyos-customization package **${{ env.CUSTOMIZATION_VERSION }}**:
            - âœ… Custom default configuration (`config.boot.default`)
            - âœ… Post-installation scripts (`postinst`)
            - âœ… Auto-install functionality (`vyos-auto-install`)
            - âœ… Password generation utilities
            
            ðŸ“¦ Package: [vyos-customization ${{ env.CUSTOMIZATION_VERSION }}](https://github.com/hauke-cloud/vyos-customization/releases/tag/${{ env.CUSTOMIZATION_VERSION }})
            
            ## ðŸ“– Documentation
            
            See the [repository README](https://github.com/${{ github.repository }}) for detailed usage instructions.
            
            ## âœ… Verification
            
            Verify your download with SHA256:
            ```bash
            sha256sum -c SHA256SUMS
            ```
          files: |
            release-artifacts/${{ steps.build_generic_iso.outputs.generic_image_iso }}
            release-artifacts/manifest.json
            release-artifacts/README.md
            release-artifacts/SHA256SUMS
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
