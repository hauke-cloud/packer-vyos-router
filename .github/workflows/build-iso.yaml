name: VyOS nightly build

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      BUILD_BY:
        description: "Build by identifier"
        required: false
        default: "hauke-cloud"
      build_version:
        description: "Build version (leave empty for auto-generated)"
        required: false

env:
  BUILD_BY: hauke-cloud
  DEBIAN_MIRROR: http://deb.debian.org/debian/
  DEBIAN_SECURITY_MIRROR: http://deb.debian.org/debian-security
  VYOS_MIRROR: https://packages.vyos.net/repositories/current/

jobs:
  build_generic_iso:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      BUILD_BY: ${{ steps.set_env_variables.outputs.BUILD_BY }}
      build_version: ${{ steps.set_env_variables.outputs.build_version }}
      TIMESTAMP: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
      generic_image_iso: ${{ steps.build_generic_iso.outputs.generic_image_iso }}
      generic_image_name: ${{ steps.build_generic_iso.outputs.generic_image_name }}

    steps:
      ### Initialization ###
      - uses: actions/checkout@v4

      - name: "Initialization: set env variables"
        id: set_env_variables
        run: |
          set -x
          if [ -n "${{ github.event.inputs.BUILD_BY }}" ]; then
            echo "BUILD_BY=${{ github.event.inputs.BUILD_BY }}" >> $GITHUB_ENV
          fi
          if [ -z "${{ github.event.inputs.build_version }}" ]; then
            echo "build_version=1.5-rolling-$(date -u +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          else
            echo "build_version=${{ github.event.inputs.build_version }}" >> $GITHUB_OUTPUT
          fi
          echo "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "BUILD_BY=$BUILD_BY" >> $GITHUB_OUTPUT

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            python3 \
            python3-pip \
            python3-venv \
            squashfs-tools \
            genisoimage \
            fakechroot \
            jq

      - name: Checkout vyos-build repo
        uses: actions/checkout@v4
        with:
          repository: vyos/vyos-build
          path: vyos-build

      - name: Apply custom configurations
        run: |
          # Create directories if they don't exist
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image
          
          # Copy custom config.boot.default if it exists
          if [ -f custom-iso/config/config.boot.default ]; then
            echo "Copying custom config.boot.default"
            cp custom-iso/config/config.boot.default \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/config.boot.default
          fi
          
          # Copy custom postinst script if it exists
          if [ -f custom-iso/scripts/postinst ]; then
            echo "Copying custom postinst script"
            cp custom-iso/scripts/postinst \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image/postinst
            chmod +x vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image/postinst
          fi
          
          # Copy any additional custom files from custom-iso/includes/ if directory exists
          if [ -d custom-iso/includes ]; then
            echo "Copying additional custom files"
            cp -r custom-iso/includes/* vyos-build/data/live-build-config/includes.chroot/ || true
          fi

      - name: Build generic ISO image using Docker
        id: build_generic_iso
        run: |
          cd vyos-build
          # Use Docker to build the ISO with privileged mode
          docker pull vyos/vyos-build:current

          # Run the build in Docker with privileged mode (required for mounting)
          docker run --rm \
            --privileged \
            -v "$(pwd)":/vyos \
            -w /vyos \
            -e BUILD_BY="$BUILD_BY" \
            -e DEBIAN_MIRROR="$DEBIAN_MIRROR" \
            -e DEBIAN_SECURITY_MIRROR="$DEBIAN_SECURITY_MIRROR" \
            -e VYOS_MIRROR="$VYOS_MIRROR" \
            --sysctl net.ipv6.conf.lo.disable_ipv6=0 \
            vyos/vyos-build:current \
            sudo ./build-vyos-image \
              --architecture amd64 \
              --build-by "$BUILD_BY" \
              --build-type release \
              --custom-package vyos-1x-smoketest \
              --debian-mirror "$DEBIAN_MIRROR" \
              --debian-security-mirror "$DEBIAN_SECURITY_MIRROR" \
              --version "${{ steps.set_env_variables.outputs.build_version }}" \
              --vyos-mirror "$VYOS_MIRROR" \
              generic

          cd build
          # Determine image name and iso file
          if [ -f manifest.json ]; then
            GENERIC_IMAGE_ISO=$(jq --raw-output '.artifacts[0]' manifest.json)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          else
            # Fallback: find the ISO file directly
            GENERIC_IMAGE_ISO=$(ls -1 *.iso | head -n1)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          fi

          echo "generic_image_name=${GENERIC_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "generic_image_iso=${GENERIC_IMAGE_ISO}" >> $GITHUB_OUTPUT

          # Fix ownership and move artifacts to workspace
          sudo chown -R $(id -u):$(id -g) .
          [ -f manifest.json ] && mv manifest.json $GITHUB_WORKSPACE/ || echo '{"artifacts": []}' > $GITHUB_WORKSPACE/manifest.json
          mv ${GENERIC_IMAGE_ISO} $GITHUB_WORKSPACE/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_generic_iso.outputs.generic_image_name }}
          path: |
            manifest.json
            ${{ steps.build_generic_iso.outputs.generic_image_iso }}
          retention-days: 15
          if-no-files-found: error
