name: Build ISO

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      BUILD_BY:
        description: "Build by identifier"
        required: false
        default: "hauke-cloud"
      build_version:
        description: "Build version (leave empty for auto-generated)"
        required: false

env:
  BUILD_BY: hauke-cloud
  DEBIAN_MIRROR: http://deb.debian.org/debian/
  DEBIAN_SECURITY_MIRROR: http://deb.debian.org/debian-security
  VYOS_MIRROR: https://packages.vyos.net/repositories/current/

jobs:
  build_iso:
    runs-on: ubuntu-22.04
    environment: docker.build
    permissions:
      contents: write
    outputs:
      BUILD_BY: ${{ steps.set_env_variables.outputs.BUILD_BY }}
      build_version: ${{ steps.set_env_variables.outputs.build_version }}
      TIMESTAMP: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
      generic_image_iso: ${{ steps.build_generic_iso.outputs.generic_image_iso }}
      generic_image_name: ${{ steps.build_generic_iso.outputs.generic_image_name }}
      customization_version: ${{ steps.build_generic_iso.outputs.customization_version }}
      vrrp_failover_version: ${{ steps.build_generic_iso.outputs.vrrp_failover_version }}
      is_release: ${{ steps.check_release.outputs.is_release }}
      release_version: ${{ steps.check_release.outputs.release_version }}
      release_tag: ${{ steps.check_release.outputs.release_tag }}

    steps:
      ### Initialization ###
      - uses: actions/checkout@v4

      - name: Check if this is a release build
        id: check_release
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
            echo "release_tag=$TAG" >> $GITHUB_OUTPUT
            echo "release_version=$VERSION" >> $GITHUB_OUTPUT
            echo "This is a RELEASE build: $TAG (version: $VERSION)"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "release_tag=" >> $GITHUB_OUTPUT
            echo "release_version=" >> $GITHUB_OUTPUT
            echo "This is a regular build"
          fi

      - name: "Initialization: set env variables"
        id: set_env_variables
        run: |
          set -x
          if [ -n "${{ github.event.inputs.BUILD_BY }}" ]; then
            echo "BUILD_BY=${{ github.event.inputs.BUILD_BY }}" >> $GITHUB_ENV
          fi
          if [ -z "${{ github.event.inputs.build_version }}" ]; then
            echo "build_version=1.5-rolling-$(date -u +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          else
            echo "build_version=${{ github.event.inputs.build_version }}" >> $GITHUB_OUTPUT
          fi
          echo "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "BUILD_BY=$BUILD_BY" >> $GITHUB_OUTPUT

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            python3 \
            python3-pip \
            python3-venv \
            squashfs-tools \
            genisoimage \
            fakechroot \
            jq

      - name: Checkout vyos-build repo
        uses: actions/checkout@v4
        with:
          repository: vyos/vyos-build
          path: vyos-build

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download vyos-customization package
        id: download_customization
        uses: ./.github/actions/download-deb-package
        with:
          repository: hauke-cloud/vyos-customization
          output-dir: vyos-build/packages
          package-name: vyos-customization

      - name: Download vyos-hetzner-vrrp-failover package
        id: download_vrrp_failover
        uses: ./.github/actions/download-deb-package
        with:
          repository: hauke-cloud/vyos-hetzner-vrrp-failover
          output-dir: vyos-build/packages
          package-name: vyos-hetzner-vrrp-failover

      - name: Save package metadata
        run: |
          # Export versions for use in later steps
          echo "CUSTOMIZATION_VERSION=${{ steps.download_customization.outputs.version }}" >> $GITHUB_ENV
          echo "VRRP_FAILOVER_VERSION=${{ steps.download_vrrp_failover.outputs.version }}" >> $GITHUB_ENV

          # Save version to metadata file for Packer build
          echo "${{ steps.download_customization.outputs.version }}" > vyos-build/customization-version.txt
          echo "✓ Saved customization version to customization-version.txt"

          # Save VRRP failover version
          echo "${{ steps.download_vrrp_failover.outputs.version }}" > vyos-build/vrrp-failover-version.txt
          echo "✓ Saved VRRP failover version to vrrp-failover-version.txt"

          # Save release version if this is a release build
          if [ "${{ steps.check_release.outputs.is_release }}" == "true" ]; then
            echo "${{ steps.check_release.outputs.release_version }}" > vyos-build/release-version.txt
            echo "✓ Saved release version to release-version.txt"
          fi

      - name: Build generic ISO image using Docker
        id: build_generic_iso
        run: |
          cd vyos-build
          # Use Docker to build the ISO with privileged mode
          docker pull vyos/vyos-build:current

          # Run the build in Docker with privileged mode (required for mounting)
          docker run --rm \
            --privileged \
            -v "$(pwd)":/vyos \
            -w /vyos \
            -e BUILD_BY="$BUILD_BY" \
            -e DEBIAN_MIRROR="$DEBIAN_MIRROR" \
            -e DEBIAN_SECURITY_MIRROR="$DEBIAN_SECURITY_MIRROR" \
            -e VYOS_MIRROR="$VYOS_MIRROR" \
            --sysctl net.ipv6.conf.lo.disable_ipv6=0 \
            vyos/vyos-build:current \
            sudo ./build-vyos-image \
              --architecture amd64 \
              --build-by "$BUILD_BY" \
              --build-type release \
              --custom-package vyos-1x-smoketest \
              --custom-package cloud-init \
              --custom-package python3-systemd \
              --custom-package ifupdown \
              --custom-package python3-yaml \
              --custom-package python3-hcloud \
              --debian-mirror "$DEBIAN_MIRROR" \
              --debian-security-mirror "$DEBIAN_SECURITY_MIRROR" \
              --version "${{ steps.set_env_variables.outputs.build_version }}" \
              --vyos-mirror "$VYOS_MIRROR" \
              generic

          cd build
          # Determine image name and iso file
          if [ -f manifest.json ]; then
            GENERIC_IMAGE_ISO=$(jq --raw-output '.artifacts[0]' manifest.json)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          else
            # Fallback: find the ISO file directly
            GENERIC_IMAGE_ISO=$(ls -1 *.iso | head -n1)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          fi

          # Rename ISO to include customization version
          NEW_ISO_NAME="${GENERIC_IMAGE_NAME}-custom-${CUSTOMIZATION_VERSION}.iso"
          sudo mv "${GENERIC_IMAGE_ISO}" "${NEW_ISO_NAME}"
          GENERIC_IMAGE_ISO="${NEW_ISO_NAME}"
          GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)

          echo "generic_image_name=${GENERIC_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "generic_image_iso=${GENERIC_IMAGE_ISO}" >> $GITHUB_OUTPUT
          echo "customization_version=${CUSTOMIZATION_VERSION}" >> $GITHUB_OUTPUT
          echo "vrrp_failover_version=${VRRP_FAILOVER_VERSION}" >> $GITHUB_OUTPUT

          # Fix ownership and move artifacts to workspace
          sudo chown -R $(id -u):$(id -g) .
          [ -f manifest.json ] && mv manifest.json $GITHUB_WORKSPACE/ || echo '{"artifacts": []}' > $GITHUB_WORKSPACE/manifest.json
          mv ${GENERIC_IMAGE_ISO} $GITHUB_WORKSPACE/

          # Move customization version metadata
          if [ -f ../customization-version.txt ]; then
            mv ../customization-version.txt $GITHUB_WORKSPACE/
          fi

          # Move VRRP failover version metadata
          if [ -f ../vrrp-failover-version.txt ]; then
            mv ../vrrp-failover-version.txt $GITHUB_WORKSPACE/
          fi

          # Move release version metadata if exists
          if [ -f ../release-version.txt ]; then
            mv ../release-version.txt $GITHUB_WORKSPACE/
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_generic_iso.outputs.generic_image_name }}
          path: |
            manifest.json
            customization-version.txt
            vrrp-failover-version.txt
            release-version.txt
            ${{ steps.build_generic_iso.outputs.generic_image_iso }}
          retention-days: 15
          if-no-files-found: error

      - name: Create GitHub Release
        if: steps.check_release.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_release.outputs.release_tag }}
          name: Release ${{ steps.check_release.outputs.release_tag }}
          body: |
            # VyOS Router Release ${{ steps.check_release.outputs.release_tag }}

            ## Build Information

            - **Release Version**: ${{ steps.check_release.outputs.release_version }}
            - **VyOS Build Version**: ${{ steps.set_env_variables.outputs.build_version }}
            - **VyOS Customization Version**: ${{ steps.build_generic_iso.outputs.customization_version }}
            - **Build Date**: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
            - **Built By**: ${{ steps.set_env_variables.outputs.BUILD_BY }}

            ## ISO Image

            - **Filename**: ${{ steps.build_generic_iso.outputs.generic_image_iso }}

            ## Installation

            Download the ISO image and use it with the Packer template or deploy manually.

            For Packer builds with this release:
            ```bash
            packer build \
              -var="vyos_iso_path=./${{ steps.build_generic_iso.outputs.generic_image_iso }}" \
              -var="vyos_customization_version=${{ steps.build_generic_iso.outputs.customization_version }}" \
              -var="release_version=${{ steps.check_release.outputs.release_version }}" \
              vyos.pkr.hcl
            ```

            ## Customizations

            This release includes customizations from [vyos-customization ${{ steps.build_generic_iso.outputs.customization_version }}](https://github.com/hauke-cloud/vyos-customization/releases/tag/${{ steps.build_generic_iso.outputs.customization_version }}).
          draft: false
          prerelease: false
          files: |
            ${{ steps.build_generic_iso.outputs.generic_image_iso }}
            customization-version.txt
            vrrp-failover-version.txt
            release-version.txt
            manifest.json
