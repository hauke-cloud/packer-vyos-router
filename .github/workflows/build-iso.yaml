name: VyOS nightly build

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      BUILD_BY:
        description: "Build by identifier"
        required: false
        default: "hauke-cloud"
      build_version:
        description: "Build version (leave empty for auto-generated)"
        required: false

env:
  BUILD_BY: hauke-cloud
  DEBIAN_MIRROR: http://deb.debian.org/debian/
  DEBIAN_SECURITY_MIRROR: http://deb.debian.org/debian-security
  VYOS_MIRROR: https://packages.vyos.net/repositories/current/

jobs:
  build_generic_iso:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      BUILD_BY: ${{ steps.set_env_variables.outputs.BUILD_BY }}
      build_version: ${{ steps.set_env_variables.outputs.build_version }}
      TIMESTAMP: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
      generic_image_iso: ${{ steps.build_generic_iso.outputs.generic_image_iso }}
      generic_image_name: ${{ steps.build_generic_iso.outputs.generic_image_name }}

    steps:
      ### Initialization ###
      - uses: actions/checkout@v4

      - name: "Initialization: set env variables"
        id: set_env_variables
        run: |
          set -x
          if [ -n "${{ github.event.inputs.BUILD_BY }}" ]; then
            echo "BUILD_BY=${{ github.event.inputs.BUILD_BY }}" >> $GITHUB_ENV
          fi
          if [ -z "${{ github.event.inputs.build_version }}" ]; then
            echo "build_version=1.5-rolling-$(date -u +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          else
            echo "build_version=${{ github.event.inputs.build_version }}" >> $GITHUB_OUTPUT
          fi
          echo "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "BUILD_BY=$BUILD_BY" >> $GITHUB_OUTPUT

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            build-essential \
            python3 \
            python3-pip \
            python3-venv \
            squashfs-tools \
            genisoimage \
            fakechroot \
            jq

      - name: Checkout vyos-build repo
        uses: actions/checkout@v4
        with:
          repository: vyos/vyos-build
          path: vyos-build

      - name: Apply custom configurations
        run: |
          # Create directories if they don't exist
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/cloud-init
          
          # Copy custom config.boot.default if it exists
          if [ -f custom-iso/config/config.boot.default ]; then
            echo "Copying custom config.boot.default"
            cp custom-iso/config/config.boot.default \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/config.boot.default
          fi
          
          # Copy custom postinst script if it exists
          if [ -f custom-iso/scripts/postinst ]; then
            echo "Copying custom postinst script"
            cp custom-iso/scripts/postinst \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image/postinst
            chmod +x vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/install-image/postinst
          fi
          
          # Copy cloud-init example configurations into the ISO
          echo "Copying cloud-init example configurations"
          if [ -f cloud-init.yaml.example ]; then
            cp cloud-init.yaml.example \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/cloud-init/cloud-init.yaml.example
          fi
          if [ -f cloud-init-vyos.yaml ]; then
            cp cloud-init-vyos.yaml \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/cloud-init/cloud-init-vyos.example.yaml
          fi
          if [ -f cloud-init-gateway.yaml ]; then
            cp cloud-init-gateway.yaml \
              vyos-build/data/live-build-config/includes.chroot/opt/vyatta/etc/cloud-init/cloud-init-gateway.example.yaml
          fi
          
          # Create a helper script to install cloud-config
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/local/bin
          cat > vyos-build/data/live-build-config/includes.chroot/usr/local/bin/install-cloud-config << 'INSTALL_SCRIPT'
          #!/bin/bash
          # Helper script to install cloud-config from examples
          
          set -e
          
          EXAMPLES_DIR="/opt/vyatta/etc/cloud-init"
          DEST_DIR="/opt/vyatta/etc/cloud"
          
          usage() {
            echo "Usage: $0 [example-name]"
            echo ""
            echo "Install cloud-config from examples into /opt/vyatta/etc/cloud/"
            echo ""
            echo "Available examples:"
            if [ -d "$EXAMPLES_DIR" ]; then
              for file in "$EXAMPLES_DIR"/*.example.yaml; do
                [ -f "$file" ] && echo "  - $(basename "$file" .example.yaml)"
              done
            fi
            echo ""
            echo "Examples:"
            echo "  $0 cloud-init-vyos    # Install VyOS cloud-init config"
            echo "  $0 cloud-init-gateway # Install gateway cloud-init config"
            exit 1
          }
          
          if [ $# -eq 0 ]; then
            usage
          fi
          
          EXAMPLE_NAME="$1"
          EXAMPLE_FILE="$EXAMPLES_DIR/${EXAMPLE_NAME}.example.yaml"
          
          if [ ! -f "$EXAMPLE_FILE" ]; then
            echo "Error: Example file not found: $EXAMPLE_FILE"
            usage
          fi
          
          # Create destination directory
          mkdir -p "$DEST_DIR/cloud.cfg.d"
          
          # Copy the configuration
          cp "$EXAMPLE_FILE" "$DEST_DIR/cloud.cfg.d/99-custom.cfg"
          
          echo "Cloud-config installed successfully!"
          echo "Installed: $EXAMPLE_FILE -> $DEST_DIR/cloud.cfg.d/99-custom.cfg"
          echo ""
          echo "You can now use cloud-init with this configuration."
          INSTALL_SCRIPT
          
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/local/bin/install-cloud-config
          
          # Copy any additional custom files from custom-iso/includes/ if directory exists
          if [ -d custom-iso/includes ]; then
            echo "Copying additional custom files"
            cp -r custom-iso/includes/* vyos-build/data/live-build-config/includes.chroot/ || true
          fi

      - name: Build generic ISO image using Docker
        id: build_generic_iso
        run: |
          cd vyos-build
          # Use Docker to build the ISO with privileged mode
          docker pull vyos/vyos-build:current

          # Run the build in Docker with privileged mode (required for mounting)
          docker run --rm \
            --privileged \
            -v "$(pwd)":/vyos \
            -w /vyos \
            -e BUILD_BY="$BUILD_BY" \
            -e DEBIAN_MIRROR="$DEBIAN_MIRROR" \
            -e DEBIAN_SECURITY_MIRROR="$DEBIAN_SECURITY_MIRROR" \
            -e VYOS_MIRROR="$VYOS_MIRROR" \
            --sysctl net.ipv6.conf.lo.disable_ipv6=0 \
            vyos/vyos-build:current \
            sudo ./build-vyos-image \
              --architecture amd64 \
              --build-by "$BUILD_BY" \
              --build-type release \
              --custom-package vyos-1x-smoketest \
              --debian-mirror "$DEBIAN_MIRROR" \
              --debian-security-mirror "$DEBIAN_SECURITY_MIRROR" \
              --version "${{ steps.set_env_variables.outputs.build_version }}" \
              --vyos-mirror "$VYOS_MIRROR" \
              generic

          cd build
          # Determine image name and iso file
          if [ -f manifest.json ]; then
            GENERIC_IMAGE_ISO=$(jq --raw-output '.artifacts[0]' manifest.json)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          else
            # Fallback: find the ISO file directly
            GENERIC_IMAGE_ISO=$(ls -1 *.iso | head -n1)
            GENERIC_IMAGE_NAME=$(basename "${GENERIC_IMAGE_ISO}" .iso)
          fi

          echo "generic_image_name=${GENERIC_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "generic_image_iso=${GENERIC_IMAGE_ISO}" >> $GITHUB_OUTPUT

          # Fix ownership and move artifacts to workspace
          sudo chown -R $(id -u):$(id -g) .
          [ -f manifest.json ] && mv manifest.json $GITHUB_WORKSPACE/ || echo '{"artifacts": []}' > $GITHUB_WORKSPACE/manifest.json
          mv ${GENERIC_IMAGE_ISO} $GITHUB_WORKSPACE/

      - name: Prepare cloud-init examples for release
        run: |
          mkdir -p release-artifacts
          cp ${{ steps.build_generic_iso.outputs.generic_image_iso }} release-artifacts/
          cp manifest.json release-artifacts/
          
          # Copy cloud-init examples
          cp cloud-init.yaml.example release-artifacts/cloud-init.yaml.example
          [ -f cloud-init-vyos.yaml ] && cp cloud-init-vyos.yaml release-artifacts/cloud-init-vyos.example.yaml || true
          [ -f cloud-init-gateway.yaml ] && cp cloud-init-gateway.yaml release-artifacts/cloud-init-gateway.example.yaml || true
          
          # Create README for the release
          cat > release-artifacts/README.md << 'EOF'
          # VyOS Custom ISO Release
          
          ## Files Included
          
          - **ISO File**: `${{ steps.build_generic_iso.outputs.generic_image_iso }}` - The custom VyOS ISO image
          - **manifest.json**: Build manifest with metadata
          - **cloud-init examples**: Example cloud-init configuration files
          
          ## Usage
          
          ### 1. Download the ISO
          
          Download the ISO file from this release and use it to install VyOS.
          
          ### 2. Cloud-Init Configuration
          
          The included cloud-init example files show how to configure VyOS on first boot:
          
          - `cloud-init.yaml.example` - Basic cloud-init template
          - `cloud-init-vyos.example.yaml` - VyOS-specific configuration
          - `cloud-init-gateway.example.yaml` - Gateway/router configuration
          
          ### 3. Using with Hetzner Cloud
          
          ```bash
          # Create server with cloud-init
          hcloud server create \
            --name vyos-router \
            --type cx23 \
            --image <snapshot-id> \
            --location nbg1 \
            --user-data-from-file cloud-init-vyos.yaml
          ```
          
          ## Build Information
          
          - **Version**: ${{ steps.set_env_variables.outputs.build_version }}
          - **Built by**: ${{ steps.set_env_variables.outputs.BUILD_BY }}
          - **Build time**: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
          - **Architecture**: amd64
          - **Type**: rolling release
          
          ## Customizations
          
          This ISO includes custom configurations from the repository:
          - Custom default configuration (if present)
          - Post-installation scripts (if present)
          - Additional packages and modifications
          
          See the repository for full customization details.
          EOF
          
          # Create checksums
          cd release-artifacts
          sha256sum ${{ steps.build_generic_iso.outputs.generic_image_iso }} > SHA256SUMS
          sha256sum manifest.json >> SHA256SUMS
          cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_generic_iso.outputs.generic_image_name }}
          path: |
            manifest.json
            ${{ steps.build_generic_iso.outputs.generic_image_iso }}
          retention-days: 15
          if-no-files-found: error

      - name: Create Release
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.set_env_variables.outputs.build_version }}
          name: VyOS ${{ steps.set_env_variables.outputs.build_version }}
          body: |
            # VyOS Custom ISO Build
            
            Automated build of VyOS with custom configurations.
            
            ## ðŸ“¦ Downloads
            
            - **ISO Image**: Download the `.iso` file below
            - **Cloud-Init Examples**: Configuration templates for automated setup
            - **SHA256SUMS**: Verify download integrity
            
            ## ðŸš€ Quick Start
            
            1. Download the ISO file
            2. Use with your preferred virtualization platform or cloud provider
            3. Customize using the included cloud-init examples
            
            ## ðŸ“‹ Build Details
            
            - **Version**: ${{ steps.set_env_variables.outputs.build_version }}
            - **Built by**: ${{ steps.set_env_variables.outputs.BUILD_BY }}
            - **Build time**: ${{ steps.set_env_variables.outputs.TIMESTAMP }}
            - **Architecture**: amd64 (generic)
            - **Commit**: ${{ github.sha }}
            
            ## ðŸ”§ Included Customizations
            
            This build includes any custom configurations present in the repository:
            - Default VyOS configuration (`config.boot.default`)
            - Post-installation scripts (`postinst`)
            - Cloud-init support for automated provisioning
            
            ## ðŸ“– Documentation
            
            See the [repository README](https://github.com/${{ github.repository }}) for detailed usage instructions.
            
            ## âœ… Verification
            
            Verify your download with SHA256:
            ```bash
            sha256sum -c SHA256SUMS
            ```
          files: |
            release-artifacts/${{ steps.build_generic_iso.outputs.generic_image_iso }}
            release-artifacts/manifest.json
            release-artifacts/README.md
            release-artifacts/cloud-init.yaml.example
            release-artifacts/cloud-init-vyos.example.yaml
            release-artifacts/cloud-init-gateway.example.yaml
            release-artifacts/SHA256SUMS
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
